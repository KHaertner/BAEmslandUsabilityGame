<!DOCTYPE html>
<!--
    Copyright (c) 2012-2014 Adobe Systems Incorporated. All rights reserved.

    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
     KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.
-->
<html>
<head>
	<meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="msapplication-tap-highlight" content="no" />
	<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>   
   <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
    <title>FH-Osna-Usability</title>
	<link rel="stylesheet" type="text/css" href="style/style.css">
	<script src="jquery.js"></script>
	<script src="timer.js"></script>
	<script type="text/javascript">

		var number = 0;									//Anzahl der gespawnten Hindernisse
		var width = $(window).innerWidth();				//Breite der Frame, ist leider noch z.T. hardcoded
		var height = $(window).innerHeight();			//Höhe der Frame, ist leider noch z.T. hardcoded
		var state = "menu";								//Startwert des Fensters (menu/play)
		var maxTime = 10000;							//Maxwert, den ein Hindernis brauch um von links nach rechts zu gelangen in ms
		var minTime = 5000;								//Minwert, den ein Hindernis brauch um von links nach rechts zu gelangen in ms
		var intervall = 200;							//Nach 200 ms wird ein neues Hindernis gespawnt
		var hardness = "slow";
		var energyMode = false;							//Energymodus mit klick auf start ist aus zu Beginn
		var energyLeft = 0;								//Anfangsenergie
		var coin = 0;
		var ingo = false;
		var destroyed = 0;
		

		/*$(document).keydown(function(e) { 				// noch nicht implementiert, aber evtl wollen wir tasten nutzen.
		    switch(e.which) {
		        case 37: 								// left
		        ingo = true;

		        case 38: 								// up
		        break;

		        case 39: 								// right
		        ingo = false;

		        case 40: 								// down
		        break;

		        default: return; 						// exit this handler for other keys
		    }
		    e.preventDefault();
		}); */											//Ende Keyeingabe

		function timer(){
			gameinterval = window.setInterval(function(){
				inGame();
			}, intervall);								//setzt die Zeit der neuberechnung, in diesem Fall wird die Spawnmethode nach "intervall" ms aufgerufen
		}

		function inGame(){ 								//bewegt und spawnt die Hindernisse
			number++;
			if (energyMode == true && energyLeft < 1) {
				energyOff();
				$('#game').css({'cursor':'url(./images/rocket.cur), default'});
			};

			if (energyMode == true) {
				energyLeft -= 1;
			};
			createBox(number); 							//spawn
			moveBox(number);							//bewegung

			if (maxTime > 2000) {maxTime = maxTime-12;}; //Die Geschwindigkeit der Hindernisse wird erhöht
			if (minTime > 1000) {minTime = minTime-6;};

														//Der Schwierigkeitsgrad erhöht sich, Hindernisse spawnen häufiger
			if (number > 250 && hardness == "slow") { 	//Erhöhung nach 250 Hindernissen
				clearInterval(gameinterval);
				hardness = "medium";
				intervall = 100;
				timer();								//Timer wird neu gestartet, damit das neue Intervall gültig ist
			};
			if (number > 500 && hardness == "medium") {
				clearInterval(gameinterval);			//Erhöhung nach 250 Hindernissen
				hardness = "hard";
				intervall = 50;
				timer();								//Timer wird neu gestartet, damit das neue Intervall gültig ist
			};

														//Daten werden angezeigt (unter den Spielfeld)
			$('#points').val(number);
			$('#intervall').val(intervall);
			$('#max').val(maxTime);
			$('#min').val(minTime);
			$('#energy').val(energyLeft);

		}

		function setState(gameState){ 					//Zeigt die Oberfläche Modusbedingt an
			state = gameState;
			if (state == "play") {
				
				$('#game').stop();
				$('#highscore').remove();
				$('#game').animate({'background-position':'0px'},1);
				$('#cursor').css({'display': 'block'});
				$('.menu').css({'display': 'none'});
				$('.highscore').css({'display': 'none'});				
				var bgAnimate = $('#game').animate({'background-position':'-=1000px'},1*60*1000, 'linear');
				timer();
			}else if(state == "menu"){
				clearInterval(gameinterval);
				$('#highscore').remove();
				$('#cursor').css({'display': 'none'});
				$('.menu').css({'display': 'block'});
				$('.highscore').css({'display': 'block'});
			}else if(state == "highscore"){
				clearInterval(gameinterval);
				$('#highscore').remove();
				$('#cursor').css({'display': 'none'});
				$('.highscore').css({'display': 'block'});
				$('.menu').append("<iframe src='./hs.html' id='highscore' style='background:white; width:100%'>");
			};
		}

    	function lose(points, reasonid){							//Anzeige und reset der Stats
			var reason = {1:"Du bist kollidiert", 2:"Du hast die Map verlassen", 3:"Anti NoHoverCheat"};
			if (energyMode==false || reasonid == 2) {
				
				//aktualisiert die Statistik
				$('#reason').html(reason[reasonid]);
				$('#range').html("Strecke: " + points);
				$('#coins').html("Münzen(3x): " + coin);
				$('#totalscore').html("Gesamte Punktzahl: " + (coin*3 + points + destroyed*2));
				$('#destroyed').html("Kometen(2x): " + destroyed);
				$('#your_points').show();
				$('#scoreform').show();
				$('#submit').show();
				
				$('.box').remove();						//Container mit alten Stats wird gelöscht
				points = $('#points').val();
				destroyed = 0;
				number = 0;
				maxTime = 10000;
				minTime = 5000;
				intervall = 200;
				energyMode = true;
				energyLeft = 0;
				coin = 0;
				hardness = "slow";
				ingo = false;
				setState('menu');	
				$('#coin').val(coin);
				$('#destroyed').val(destroyed);
			}else{
				destroyed += 1;
				$('#box'+points).remove();
				$('#destroyed').val(destroyed);
			};
		}
		
		//Herstellen des XMLHttpRequest und Anbindung an das PHP Skript zur Übermittlung des Scores
		function submitScore(){
			
			name = $('#scoreform').val();
			
			var request = new XMLHttpRequest();
			request.open("POST", "xmlsubmit.php", true);
			request.setRequestHeader("Content-type","application/x-www-form-urlencoded");
			request.onload = function() {
				var resp = request.response;
			};
			request.send("name=" + name + "&score=" + (coin*3 + points + destroyed*2));
			
			//versteckt das Formular nachdem die Übermittlung geschehen ist
			$('#scoreform').hide();
			$('#submit').hide();
		}
		
		function createBox(id){							//Hindernis berechnen und als container anzeigen
			if (id == 1 && energyMode==true) {energy();};
			var powerUp = Math.floor(Math.random()*100);
			var y = Math.floor(Math.random() * height-10);	//Zufallszahl der Spawnhöhe
			if (y<10) {y=10;};
			if (y-height>height-10) {y=height-10;};
			var reason = 1;
			if (powerUp == 5) {
				box = $("<div id=box"+id+" class='box' style='width: 20px; height: 20px; cursor:none; background: url(./images/ingo.png); position: fixed; border-radius: 10px; left: "+width+"px; top: "+y+"px' onmouseover='getPowerUp("+id+"); energyOn(); '></div>");
			}else if(powerUp<5){
				box = $("<div id=box"+id+" class='box' style='width: 20px; height: 20px; cursor:none; background: url(./images/coin.png); position: fixed; border-radius: 10px; left: "+width+"px; top: "+y+"px' onmouseover='coins("+id+");'></div>");
			}else if(ingo == false) {
				box = $("<div id=box"+id+" class='box bad' style='width: 50px; height: 50px; cursor:none; background: url(./images/comet_big.png); position: fixed; border-radius: 50px; left: "+width+"px; top: "+y+"px' onmouseover='lose("+id+", "+reason+");'></div>");
			}else{
				box = $("<div id=box"+id+" class='box bad' style='width: 20px; height: 20px; cursor:none; background: url(./images/ingo.png); position: fixed; border-radius: 10px; left: "+width+"px; top: "+y+"px' onmouseover='lose("+id+", "+reason+");'></div>");
			};
			
			$(document.body).append(box);
			
		}

		function getPowerUp(id){
			energyLeft += 20; 
			$('#box'+id).remove();
		}

		function moveBox(id){							//Geschwindigkeit des Hindernis zufällig erzeugen
			var speed = Math.floor(Math.random() * (maxTime-minTime))+minTime;
			var left = width+100;
			var top = Math.floor(Math.random() * 300)-150;
			$("#box"+id).animate({'left' : "-="+left+"px", 'top' : "+="+top+"px"}, speed, 'linear'); //Bewegung erzeugen
		}

		function energy(){								//wechselt bei klick den cursur
			if (energyMode == false) {
				energyOn();
			}else{
				energyOff();
			};

		}

		function energyOn(){
			$('#game').css({'cursor':'url(./images/rocketenergy.cur), default'});
			energyMode = true;
		}

		function energyOff(){
			$('#game').css({'cursor':'url(./images/rocket.cur), default'});
			energyMode = false;
		}

		function coins(id){
			coin += 1;
			$('#coin').val(coin);
			$('#box'+id).remove();	
		}

		$(document).ready(function() { 					//nachdem das HTML-Dokument geladen wurde
			$('body').mousemove(function(e) { 			//Achte auf Mausbewegung
				var offset = $(this).offset();			//Berechnung der Mauskoordinaten
				var new_x = (e.clientX - offset.left);
				var new_y = (e.clientY - offset.top);
				$('#showEnergy').css({'top': new_y-6, 'left' : new_x-energyLeft+10, 'width' : energyLeft});
				$('#cursor').css({'top': new_y-5, 'left' : new_x}); //Bild (Rakete) bewegen
				$('#x').val(new_x);						//Ausgabe der x,y Koordinaten under der Frame
				$('#y').val(new_y);
				
				/*if (state == "play" && ((new_x) < -8 || (new_x) > width || (new_y) < -7 || (new_y) > height)) {
					if((number-100) < 0){number = 0}else{number = number-100};
					lose(number, 2);								//Wenn die Maus die Frame verlässt
				};*/
				

				if (number >= 100) {
					$('#box'+(number-100)).remove();	//Es werden maximal 100 Hindernisse erstellt, frühere werden gelöscht.
				};			
			});
		});	
		
		// K A R S T E N diese Funktion wird nicht zur Laufzeit erkannt :/
		// add vibration for each button
		$("button").click(function() {
			if (window.navigator && window.navigator.vibrate){
				navigator.vibrate(1000);
			}
		});
	</script>
</head>
<body>
	<!-- Frame -->
	<div id="game">

		<!-- menüoberfläche -->
		<div class="menu">
			<button onclick="setState('play');">Start</button>
			<button onclick="setState('highscore');">Highscore</button>
			
			<!-- Darstellung des Highscore -->
			<div id="your_points" style="display:none;">
				<p>Game Over</p>
				<p id='reason'></p>
				<p id='range'></p>
				<p id='coins'></p>
				<p id='destroyed'></p>
				<p id='totalscore'></p>
				<input type="text" id="scoreform" name="playername"><button id="submit" type="submit" onclick="submitScore()">Score abschicken</button>
			</div>
		
		
		
		
		
			<!-- Debug Statistiken -->
			<div class="stats" style="z-index:110; position:fixed; color: white; display: none;">
				Energy:			<input type='text' id='energy' style="width:30px">
				Coins:			<input type='text' id='coin' style="width:30px">
				Destroyed:		<input type='text' id='destroyed' style="width:30px">
								<input type='text' id='x' style="width:30px"> :
								<input type='text' id='y' style="width:30px">
				Hindernisse: 	<input type='text' id="points" style="width:30px">
				Intervall: 		<input type='text' id="intervall" style="width:30px">
				Max: 			<input type='text' id="max" style="width:30px">
				Min: 			<input type='text' id="min" style="width:30px">
			</div>
		</div>
	</div>
	

	
	<!-- <div class="border" id="top" style="height: 8px;background: black;position: fixed;z-index:  10;width: 100%;top: 0px; left: 0px;"></div>
	<div class="border" id="left" style="height: 100%;background: #000;position: fixed;z-index:  10;width: 10px;top: 0px;left: 0px;"></div>
	<div class="border" id="bottom" style="height: 100%;background: black;position: fixed;z-index: 10;width: 100%;top: 610px;left: 0px;"></div>
	<div class="border" id="right" style="height: 100%;background: black;position: fixed;z-index: 10;width: 100%;top: 0px;left: 1010px;"></div> -->

	<!-- Aussehen des Cursers/Avatar -->
	<div id="showEnergy"></div>
	<div id="cursor"></div>
</body>
</html>
